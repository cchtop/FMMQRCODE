<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>出貨單</title>
  <style>
    body{font-family:Arial,"Noto Sans TC",sans-serif;font-size:12px;margin:16px}
    .title{font-size:18px;font-weight:700;text-align:center;margin:8px 0 12px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #333;padding:6px;text-align:center}
    .meta td{text-align:left}
    @media print{ body{margin:4mm} }
  </style>
</head>
<body>
  <div id="root">載入中…</div>
<script>
const qs = new URLSearchParams(location.search);
const shipId = qs.get('ship_id');
const api = qs.get('api') || localStorage.getItem('apiUrl') || '';

if(!shipId || !api){
  document.getElementById('root').innerText = '缺少 ship_id 或 API URL';
} else {
  fetch(api + '?' + new URLSearchParams({action:'shipment', ship_id:shipId}))
    .then(r=>r.json())
    .then(d=>{
      const H = d.header||{}, L = d.lines||[];
      let total = 0;
      L.forEach(x=> total += Number(x.amount||0));
      const html = `
        <div class="title">出貨單 - ${shipId}</div>
        <table class="meta">
          <tr>
            <td>出貨日期：${H.date||''}</td>
            <td>客戶：${H.vendor_name||''}</td>
            <td>聯絡人：${H.contact||''}</td>
          </tr>
          <tr>
            <td colspan="3">地址：${H.address||''}　電話：${H.phone||''}</td>
          </tr>
        </table>
        <br>
        <table>
          <thead>
            <tr>
              <th>序</th><th>條碼</th><th>料號</th><th>品項</th><th>規格</th>
              <th>儲位</th><th>效期</th><th>出貨量</th><th>單價</th><th>金額</th>
            </tr>
          </thead>
          <tbody>
            ${L.map((ln,i)=>`
              <tr>
                <td>${i+1}</td>
                <td>${ln.barcode||''}</td>
                <td>${ln.code||''}</td>
                <td>${ln.item||''}</td>
                <td>${ln.spec||''}</td>
                <td>${ln.loc||''}</td>
                <td>${ln.exp||''}</td>
                <td>${ln.qty_out||0}</td>
                <td>${ln.unit_price||0}</td>
                <td>${ln.amount||0}</td>
              </tr>`).join('')}
            <tr><td colspan="9" style="text-align:right">合計</td><td>${total}</td></tr>
          </tbody>
        </table>
        <p>備註：${H.note||''}</p>
      `;
      document.getElementById('root').innerHTML = html;
      setTimeout(()=>window.print(), 200);
    })
    .catch(err=>{
      document.getElementById('root').innerText = '載入失敗：'+err;
    });
}
</script>
</body>
</html>

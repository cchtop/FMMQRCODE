<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>原物料管理（雲端版）</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<!-- 條碼/QR 掃描 -->
<script src="https://unpkg.com/@zxing/library@0.20.0"></script>
<style>
  body { padding: 1rem; }
  .table-responsive { max-height: 45vh; overflow-y: auto; }
  .report-border td, .report-border th { border: 1px solid #000; padding: 4px; text-align: center; }
  .signature-line { height: 40px; border-bottom: 1px solid #000; width: 160px; display: inline-block; margin-left: .5rem; margin-right: 1.5rem; }
</style>
</head>
<body class="container">
<div class="card mb-3">
  <div class="card-header">掃碼新增（條碼/QR）</div>
  <div class="card-body">
    <div class="d-flex gap-2 align-items-end flex-wrap">
      <div>
        <label class="form-label">相機</label>
        <select id="camSelect" class="form-select" style="min-width:220px"></select>
      </div>
      <button id="btnScanStart" class="btn btn-primary">啟動掃描</button>
      <button id="btnScanStop"  class="btn btn-outline-secondary">停止</button>
      <button id="btnPhotoScan" class="btn btn-outline-secondary">拍照掃碼（備援）</button>
      <span id="scanHint" class="text-muted small ms-2"></span>
      <span id="scanMsg"  class="text-danger small ms-2"></span>
    </div>

    <video id="video" playsinline muted style="width:100%;max-width:380px;margin-top:.5rem;border:1px solid #ddd;border-radius:6px"></video>
    <input id="fileScan" type="file" accept="image/*" capture="environment" class="d-none">
  </div>
</div>

<div class="card my-3">
  <div class="card-header">批次上傳 Excel → 入庫</div>
  <div class="card-body">
    <input id="bulkFile" type="file" accept=".xlsx,.xls" class="form-control" />
    <div class="form-text">欄位（第一列標題）：date, code, item, loc, in, out, stock, barcode（日期建議 YYYY-MM-DD）</div>
    <button id="btnBulk" class="btn btn-outline-success mt-2" type="button">上傳入庫</button>
    <small id="bulkMsg" class="text-muted ms-2"></small>
  </div>
</div>

  <!-- 輸入表單 -->
  <form id="matForm" class="row g-3 align-items-end">
    <div class="col-6 col-md-3">
      <label class="form-label">日期</label>
      <input id="matDate" type="date" class="form-control" required>
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">料號</label>
      <input id="matCode" type="text" class="form-control" />
    </div>
    <div class="col-12 col-md-4">
      <label class="form-label">品項</label>
      <input id="matItem" type="text" class="form-control" required />
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">儲位</label>
      <input id="matLoc" type="text" class="form-control" />
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">進料量(+)</label>
      <input id="matIn" type="number" step="any" class="form-control" value="0" />
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">領料量(-)</label>
      <input id="matOut" type="number" step="any" class="form-control" value="0" />
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">掃描條碼</label>
      <input id="matBarcode" type="text" class="form-control" placeholder="可由掃描自動帶入" />
    </div>
    <div class="col-12 col-md-2 d-grid">
      <button class="btn btn-primary" type="submit">新增 / 更新</button>
    </div>
  </form>

  <!-- 即時列表（本頁暫存顯示） -->
  <div class="table-responsive mt-3">
    <table id="matTable" class="table table-sm table-striped">
      <thead class="table-light">
        <tr>
          <th>日期</th><th>條碼</th><th>料號</th><th>品項</th><th>儲位</th>
          <th>進料量</th><th>領料量</th><th>庫存量</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- 查詢卡片（線上查詢） -->
  <div class="card my-3">
    <div class="card-header">線上查詢（Google Sheet）</div>
    <div class="card-body">
      <div class="row g-2">
        <div class="col-6 col-md-3"><label class="form-label">日期自</label><input id="qFrom" type="date" class="form-control"></div>
        <div class="col-6 col-md-3"><label class="form-label">日期至</label><input id="qTo" type="date" class="form-control"></div>
        <div class="col-6 col-md-2"><label class="form-label">料號含</label><input id="qCode" type="text" class="form-control"></div>
        <div class="col-6 col-md-2"><label class="form-label">品項含</label><input id="qItem" type="text" class="form-control"></div>
        <div class="col-6 col-md-2"><label class="form-label">儲位含</label><input id="qLoc"  type="text" class="form-control"></div>
      </div>
      <div class="mt-2 d-flex gap-2">
        <button id="btnQuery" class="btn btn-outline-primary" type="button">查詢</button>
        <button id="btnQueryXlsx" class="btn btn-success" type="button">匯出查詢結果 Excel</button>
      </div>
      <div class="table-responsive mt-2">
        <table id="qTable" class="table table-sm">
          <thead><tr>
            <th>日期</th><th>條碼</th><th>料號</th><th>品項</th><th>儲位</th>
            <th>進料量</th><th>領料量</th><th>庫存量</th><th>寫入時間</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  <button id="btnSummary" class="btn btn-warning" type="button">彙總(同日×料號×品項×儲位)</button>
<script>
/* ============ 你自己的 GAS Web App URL（/exec） ============ */
const GAS_URL = 'https://script.google.com/macros/s/AKfycbxlGqIKZJNDl0FSZ1zz34rVehVP7GbB04KeUCVzSV2MIxDFo32orML9PLfSds9r102Gkg/exec';

/* ============ DOM references ============ */
const video    = document.getElementById('video');
const camSel   = document.getElementById('camSelect');
const btnStart = document.getElementById('btnScanStart');
const btnStop  = document.getElementById('btnScanStop');
const btnPhoto = document.getElementById('btnPhotoScan');
const fileScan = document.getElementById('fileScan');
const scanMsg  = document.getElementById('scanMsg');
const scanHint = document.getElementById('scanHint');

const tbody    = document.querySelector('#matTable tbody');
const qBody    = document.querySelector('#qTable tbody');

let data = [];                 // 本頁暫存顯示
let currentDeviceId = null;

/* ============ 掃描器（只掃 1D 條碼） ============ */
const formats = [
  ZXing.BarcodeFormat.EAN_13, ZXing.BarcodeFormat.EAN_8,
  ZXing.BarcodeFormat.UPC_A,  ZXing.BarcodeFormat.CODE_128,
  ZXing.BarcodeFormat.CODE_39, ZXing.BarcodeFormat.ITF
];
const hints = new Map([[ZXing.DecodeHintType.POSSIBLE_FORMATS, formats]]);
const codeReader = new ZXing.BrowserMultiFormatReader(hints, 400);

const isLINE = /Line/i.test(navigator.userAgent);
if (isLINE) scanHint.textContent = '提示：LINE 內建瀏覽器常擋鏡頭，右上角「在瀏覽器開啟」成功率較高。';

function setScanMsg(t){ scanMsg.textContent = t || ''; }

async function ensureCamPermission(){
  try{
    const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}}, audio:false});
    s.getTracks().forEach(t=>t.stop());
    return true;
  }catch{ return false; }
}

async function listCams(){
  try{
    const devs = await navigator.mediaDevices.enumerateDevices();
    const cams = devs.filter(d=>d.kind==='videoinput');
    if (!cams.length) { setScanMsg('找不到鏡頭（可能權限被拒）'); return; }
    cams.sort((a,b)=>{
      const sa=(a.label||'').toLowerCase(), sb=(b.label||'').toLowerCase();
      const ra=/back|rear|environment/.test(sa)?0:1, rb=/back|rear|environment/.test(sb)?0:1;
      return ra-rb;
    });
    camSel.innerHTML = cams.map((d,i)=>`<option value="${d.deviceId}">${d.label||`camera ${i+1}`}</option>`).join('');
    currentDeviceId = cams[0].deviceId;
  }catch(e){ setScanMsg('列出鏡頭失敗：'+e); }
}
camSel.addEventListener('change', ()=> currentDeviceId = camSel.value);

btnStart.addEventListener('click', async ()=>{
  setScanMsg('');
  const ok = await ensureCamPermission();
  if (!ok){ setScanMsg('鏡頭權限被拒，請到瀏覽器網站權限開啟或用「拍照掃碼」。'); return; }
  if (!currentDeviceId) await listCams();
  try{
    if (currentDeviceId) {
      await codeReader.decodeFromVideoDevice(currentDeviceId, video, onScan);
    } else {
      await codeReader.decodeFromConstraints({video:{facingMode:{ideal:'environment'}}}, video, onScan);
    }
  }catch(e){ setScanMsg('啟動失敗：'+e); }
});
btnStop.addEventListener('click', ()=>{ try{ codeReader.reset(); }catch{} });

function onScan(result, err){
  if (result){
    handleBarcode(result.getText());
    btnStop.click(); // 若要連續掃，把這行拿掉
  }
}

btnPhoto.addEventListener('click', ()=> fileScan.click());
fileScan.addEventListener('change', async ev=>{
  const f = ev.target.files[0]; if(!f) return;
  const url = URL.createObjectURL(f);
  try{
    const res = await new ZXing.BrowserMultiFormatReader(hints).decodeFromImageUrl(url);
    handleBarcode(res.getText());
  }catch{
    if ('BarcodeDetector' in window){
      try{
        const img = new Image(); img.src = url; await img.decode();
        const bd = new BarcodeDetector({formats:['ean_13','ean_8','upc_a','code_128','code_39','itf']});
        const r = await bd.detect(img);
        if (r && r[0] && r[0].rawValue) handleBarcode(r[0].rawValue);
        else setScanMsg('影像解碼失敗，請再拍清楚一點。');
      }catch{ setScanMsg('影像解碼失敗，請再試一次。'); }
    }else setScanMsg('此瀏覽器不支援影像解碼，請改用相機掃描。');
  }
  URL.revokeObjectURL(url);
});

function handleBarcode(code){
  document.getElementById('matBarcode').value = code;
  lookupByBarcode(code); // 若你有在 GAS 做主檔帶出，這裡呼叫即可
}

/* ============ 表單送出（寫 GAS + 本地表格） ============ */
document.getElementById('matForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const d   = matDate.value;
  const bc  = (matBarcode.value||'').trim();
  const code= matCode.value.trim();
  const it  = matItem.value.trim();
  const loc = matLoc.value.trim();
  const qIn = parseFloat(matIn.value)||0;
  const qOut= parseFloat(matOut.value)||0;

  const stock = data.filter(r=>r.date===d && r.code===code && r.item===it && r.loc===loc)
                    .reduce((a,c)=>a+c.in-c.out,0) + qIn - qOut;

  const ex = data.find(r=>r.date===d && r.code===code && r.item===it && r.loc===loc);
  if (ex){ ex.in+=qIn; ex.out+=qOut; ex.stock=stock; }
  else   { data.push({date:d, barcode:bc, code, item:it, loc, in:qIn, out:qOut, stock}); }
  renderLocal();

  try{
    await fetch(GAS_URL, {
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify({date:d, barcode:bc, code, item:it, loc, in:qIn, out:qOut, stock})
    });
  }catch(err){ console.warn('寫入 GAS 失敗：', err); }

  e.target.reset();
  matDate.value = new Date().toISOString().slice(0,10);
});
function renderLocal(){
  tbody.innerHTML = '';
  data.sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(r=>{
    tbody.insertAdjacentHTML('beforeend', `<tr>
      <td>${r.date}</td><td>${r.barcode||''}</td><td>${r.code||''}</td>
      <td>${r.item||''}</td><td>${r.loc||''}</td>
      <td>${r.in}</td><td>${r.out}</td><td>${r.stock}</td>
    </tr>`);
  });
}

/* ============ 查詢與彙總（GAS） ============ */
document.getElementById('btnQuery').addEventListener('click', async ()=>{
  const qs = new URLSearchParams({
    action:'query',
    from: qFrom.value || '', to: qTo.value || '',
    code: qCode.value || '', item: qItem.value || '', loc: qLoc.value || ''
  }).toString();
  try{
    const r = await fetch(`${GAS_URL}?${qs}`);
    const j = await r.json();
    qBody.innerHTML='';
    (j.rows||[]).forEach(r=>{
      qBody.insertAdjacentHTML('beforeend', `<tr>
        <td>${r.date||''}</td><td>${r.barcode||''}</td><td>${r.code||''}</td>
        <td>${r.item||''}</td><td>${r.loc||''}</td>
        <td>${r.in||0}</td><td>${r.out||0}</td><td>${r.stock||0}</td><td>${r.ts||''}</td>
      </tr>`);
    });
  }catch(e){ alert('查詢失敗：'+e); }
});

document.getElementById('btnSummary').addEventListener('click', async ()=>{
  const qs = new URLSearchParams({
    action:'summary',
    from: qFrom.value || '', to: qTo.value || '',
    code: qCode.value || '', item: qItem.value || '', loc: qLoc.value || ''
  }).toString();
  try{
    const r = await fetch(`${GAS_URL}?${qs}`); const j = await r.json();
    qBody.innerHTML='';
    (j.rows||[]).forEach(r=>{
      qBody.insertAdjacentHTML('beforeend', `<tr>
        <td>${r.date||''}</td><td></td><td>${r.code||''}</td><td>${r.item||''}</td><td>${r.loc||''}</td>
        <td>${r.in||0}</td><td>${r.out||0}</td><td>${r.stockEnd||0}</td><td></td>
      </tr>`);
    });
  }catch(e){ alert('彙總失敗：'+e); }
});

/* ============ 批次上傳 Excel（日期正規化 + 分批送） ============ */
function excelDateToISO(v){
  if (typeof v === 'number'){                 // e.g. 45901
    const d = XLSX.SSF.parse_date_code(v);
    const dt = new Date(Date.UTC(d.y, d.m-1, d.d));
    return dt.toISOString().slice(0,10);
  }
  if (typeof v === 'string'){
    const m = v.match(/(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/);
    if (m) return `${m[1]}-${String(+m[2]).padStart(2,'0')}-${String(+m[3]).padStart(2,'0')}`;
  }
  return '';
}
document.getElementById('btnBulk').addEventListener('click', async ()=>{
  const f = document.getElementById('bulkFile').files[0];
  if(!f){ alert('請選擇 Excel'); return; }
  const ab = await f.arrayBuffer();
  const wb = XLSX.read(ab);
  const ws = wb.Sheets[wb.SheetNames[0]];
  const arr = XLSX.utils.sheet_to_json(ws, {defval:''});

  const rows = arr.map(o=>({
    date:    excelDateToISO(o.date||o.日期||''),
    code:    o.code||o.料號||'',
    item:    o.item||o.品項||'',
    loc:     o.loc||o.儲位||'',
    in:      Number(o.in||o.進料量||0),
    out:     Number(o.out||o.領料量||0),
    stock:   Number(o.stock||o.庫存量||0),
    barcode: o.barcode||o.條碼||''
  })).filter(r=>r.date && (r.in||r.out||r.stock||r.code||r.item));

  if(!rows.length){ alert('沒有可匯入的資料列'); return; }

  const chunk = 200;
  for (let i=0;i<rows.length;i+=chunk){
    const part = rows.slice(i, i+chunk);
    await fetch(GAS_URL, {
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify({rows: part})
    });
    document.getElementById('bulkMsg').textContent = `已上傳 ${Math.min(i+chunk, rows.length)} / ${rows.length}`;
  }
  alert('批次入庫完成');
});

/* ============ 初始：今天日期 + 權限 + 鏡頭清單 ============ */
(function(){
  const t = new Date().toISOString().slice(0,10);
  matDate.value = t; qFrom.value = t; qTo.value = t;
  ensureCamPermission().then(listCams);
})();
</script>
</body>
</html>


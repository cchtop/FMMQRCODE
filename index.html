<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>原物料管理（雲端版）</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<!-- 條碼/QR 掃描 -->
<script src="https://unpkg.com/@zxing/library@0.20.0"></script>
<style>
  body { padding: 1rem; }
  .table-responsive { max-height: 45vh; overflow-y: auto; }
  .report-border td, .report-border th { border: 1px solid #000; padding: 4px; text-align: center; }
  .signature-line { height: 40px; border-bottom: 1px solid #000; width: 160px; display: inline-block; margin-left: .5rem; margin-right: 1.5rem; }
</style>
</head>
<body class="container">
  <h3 class="my-2">原物料管理（雲端）</h3>

  <!-- 掃碼區 -->
  <div class="card mb-3">
    <div class="card-header">掃碼新增（條碼/QR）</div>
    <div class="card-body">
      <div class="d-flex gap-2 align-items-end flex-wrap">
        <div>
          <label class="form-label">相機</label>
          <select id="camSelect" class="form-select" style="min-width:220px"></select>
        </div>
        <button id="btnScanStart" class="btn btn-outline-primary">啟動掃描</button>
        <button id="btnScanStop" class="btn btn-outline-secondary">停止</button>
        <span id="scanMsg" class="text-danger small ms-2"></span>
      </div>
      <video id="video" style="width:100%;max-width:380px;margin-top:.5rem;border:1px solid #ddd;border-radius:6px"></video>
    </div>
  </div>

  <!-- 輸入表單 -->
  <form id="matForm" class="row g-3 align-items-end">
    <div class="col-6 col-md-3">
      <label class="form-label">日期</label>
      <input id="matDate" type="date" class="form-control" required />
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">料號</label>
      <input id="matCode" type="text" class="form-control" />
    </div>
    <div class="col-12 col-md-4">
      <label class="form-label">品項</label>
      <input id="matItem" type="text" class="form-control" required />
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">儲位</label>
      <input id="matLoc" type="text" class="form-control" />
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">進料量(+)</label>
      <input id="matIn" type="number" step="any" class="form-control" value="0" />
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">領料量(-)</label>
      <input id="matOut" type="number" step="any" class="form-control" value="0" />
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">掃描條碼</label>
      <input id="matBarcode" type="text" class="form-control" placeholder="可由掃描自動帶入" />
    </div>
    <div class="col-12 col-md-2 d-grid">
      <button class="btn btn-primary" type="submit">新增 / 更新</button>
    </div>
  </form>

  <!-- 即時列表（本頁暫存顯示） -->
  <div class="table-responsive mt-3">
    <table id="matTable" class="table table-sm table-striped">
      <thead class="table-light">
        <tr>
          <th>日期</th><th>條碼</th><th>料號</th><th>品項</th><th>儲位</th>
          <th>進料量</th><th>領料量</th><th>庫存量</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- 查詢卡片（線上查詢） -->
  <div class="card my-3">
    <div class="card-header">線上查詢（Google Sheet）</div>
    <div class="card-body">
      <div class="row g-2">
        <div class="col-6 col-md-3"><label class="form-label">日期自</label><input id="qFrom" type="date" class="form-control"></div>
        <div class="col-6 col-md-3"><label class="form-label">日期至</label><input id="qTo" type="date" class="form-control"></div>
        <div class="col-6 col-md-2"><label class="form-label">料號含</label><input id="qCode" type="text" class="form-control"></div>
        <div class="col-6 col-md-2"><label class="form-label">品項含</label><input id="qItem" type="text" class="form-control"></div>
        <div class="col-6 col-md-2"><label class="form-label">儲位含</label><input id="qLoc"  type="text" class="form-control"></div>
      </div>
      <div class="mt-2 d-flex gap-2">
        <button id="btnQuery" class="btn btn-outline-primary" type="button">查詢</button>
        <button id="btnQueryXlsx" class="btn btn-success" type="button">匯出查詢結果 Excel</button>
      </div>
      <div class="table-responsive mt-2">
        <table id="qTable" class="table table-sm">
          <thead><tr>
            <th>日期</th><th>條碼</th><th>料號</th><th>品項</th><th>儲位</th>
            <th>進料量</th><th>領料量</th><th>庫存量</th><th>寫入時間</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
  // === 你的 GAS Web App URL ===
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbx4656Lz-12jAy3ElkCUtKpTPtp56MfxUIL4-ReTTTRn_7arAS5SLefY-ZdlEMoJt3vBQ/exec';

  // === 前端暫存資料（只用於本頁顯示，不是權威資料來源） ===
  let data = [];
  const tbody = document.querySelector('#matTable tbody');

  // === 掃碼：列出相機、啟動/停止 ===
  const video = document.getElementById('video');
  const camSel = document.getElementById('camSelect');
  const scanMsg = document.getElementById('scanMsg');
  const codeReader = new ZXing.BrowserMultiFormatReader();
  let currentDeviceId = null;

  async function listCams(){
    try{
      const devices = await ZXing.BrowserCodeReader.listVideoInputDevices();
      camSel.innerHTML = devices.map(d=>`<option value="${d.deviceId}">${d.label||d.deviceId}</option>`).join('');
      if(devices[0]) currentDeviceId = devices[0].deviceId;
    }catch(e){ scanMsg.textContent = '找不到鏡頭：'+e; }
  }
  camSel.addEventListener('change',()=> currentDeviceId = camSel.value);

  document.getElementById('btnScanStart').addEventListener('click', async ()=>{
    scanMsg.textContent='';
    if(!currentDeviceId) await listCams();
    try{
      await codeReader.decodeFromVideoDevice(currentDeviceId, video, (result, err)=>{
        if(result){
          const text = result.getText();
          // 1) 顯示到條碼欄
          document.getElementById('matBarcode').value = text;
          // 2) 向 GAS 取主檔
          lookupByBarcode(text);
          // 3) 讀到即停（也可改成連續模式）
          stopScan();
        }
      });
    }catch(e){ scanMsg.textContent = '啟動失敗：'+e; }
  });
  document.getElementById('btnScanStop').addEventListener('click', stopScan);
  function stopScan(){ try{ codeReader.reset(); }catch{} }

  async function lookupByBarcode(bc){
    try{
      const url = `${GAS_URL}?action=lookup&barcode=${encodeURIComponent(bc)}`;
      const r = await fetch(url); const j = await r.json();
      if(j && (j.code || j.item)){
        if(j.code) document.getElementById('matCode').value = j.code;
        if(j.item) document.getElementById('matItem').value = j.item;
        if(j.loc)  document.getElementById('matLoc').value  = j.loc;
      }else{
        scanMsg.textContent = '主檔無此條碼，可手動輸入';
      }
    }catch(e){ scanMsg.textContent = '主檔查詢失敗：'+e; }
  }

  // === 送出：本地合併 + 寫入 GAS（Transactions） ===
  document.getElementById('matForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const d = matDate.value;
    const code = matCode.value.trim();
    const it   = matItem.value.trim();
    const loc  = matLoc.value.trim();
    const qIn  = parseFloat(matIn.value)||0;
    const qOut = parseFloat(matOut.value)||0;
    const bc   = (matBarcode.value||'').trim();

    const stock = data
      .filter(r => r.date===d && r.code===code && r.item===it && r.loc===loc)
      .reduce((a,c)=> a + c.in - c.out, 0) + qIn - qOut;

    const ex = data.find(r => r.date===d && r.code===code && r.item===it && r.loc===loc);
    if(ex){ ex.in+=qIn; ex.out+=qOut; ex.stock=stock; }
    else  { data.push({date:d, barcode:bc, code, item:it, loc, in:qIn, out:qOut, stock}); }

    renderLocal();
    e.target.reset(); matDate.value = new Date().toISOString().slice(0,10);

    // 寫入 GAS
    try{
      await fetch(GAS_URL, {
        method:'POST',
        headers:{'Content-Type':'text/plain;charset=utf-8'}, // 避免預檢
        body: JSON.stringify({date:d, barcode:bc, code, item:it, loc, in:qIn, out:qOut, stock})
        // 若公司網路很嚴格，可加 mode:'no-cors'
      });
    }catch(e){ console.warn('寫入 GAS 失敗：', e); }
  });

  function renderLocal(){
    tbody.innerHTML='';
    data.sort((a,b)=> new Date(a.date)-new Date(b.date)).forEach(r=>{
      tbody.insertAdjacentHTML('beforeend', `<tr>
        <td>${r.date}</td><td>${r.barcode||''}</td><td>${r.code||''}</td>
        <td>${r.item||''}</td><td>${r.loc||''}</td>
        <td>${r.in}</td><td>${r.out}</td><td>${r.stock}</td>
      </tr>`);
    });
  }

  // === 線上查詢（讀 Transactions） ===
  const qBody = document.querySelector('#qTable tbody');
  document.getElementById('btnQuery').addEventListener('click', async ()=>{
    const qs = new URLSearchParams({
      action:'query',
      from: qFrom.value || '',
      to:   qTo.value   || '',
      code: qCode.value || '',
      item: qItem.value || '',
      loc:  qLoc.value  || ''
    }).toString();
    try{
      const r = await fetch(`${GAS_URL}?${qs}`);
      const j = await r.json();
      qBody.innerHTML='';
      (j.rows||[]).forEach(r=>{
        qBody.insertAdjacentHTML('beforeend', `<tr>
          <td>${r.date||''}</td><td>${r.barcode||''}</td><td>${r.code||''}</td>
          <td>${r.item||''}</td><td>${r.loc||''}</td>
          <td>${r.in||0}</td><td>${r.out||0}</td><td>${r.stock||0}</td><td>${r.ts||''}</td>
        </tr>`);
      });
    }catch(e){ alert('查詢失敗：'+e); }
  });

  document.getElementById('btnQueryXlsx').addEventListener('click', ()=>{
    const rows = [...document.querySelectorAll('#qTable tbody tr')].map(tr=>{
      const tds = tr.querySelectorAll('td');
      return {
        日期: tds[0].innerText, 條碼: tds[1].innerText, 料號: tds[2].innerText, 品項: tds[3].innerText,
        儲位: tds[4].innerText, 進料量: tds[5].innerText, 領料量: tds[6].innerText, 庫存量: tds[7].innerText, 寫入時間: tds[8].innerText
      };
    });
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, '查詢結果');
    XLSX.writeFile(wb, 'query.xlsx');
  });

  // 預設帶今天
  (function(){
    const t = new Date().toISOString().slice(0,10);
    document.getElementById('matDate').value = t;
    document.getElementById('qFrom').value = t;
    document.getElementById('qTo').value   = t;
    listCams();
  })();
  </script>
</body>
</html>

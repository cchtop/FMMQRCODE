<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>原物料管理（雲端版）</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://unpkg.com/@zxing/library@0.20.0"></script>

<style>
  body{padding:1rem}
  .table-responsive{max-height:48vh;overflow-y:auto}
  video{width:100%;max-width:420px;border:1px solid #ddd;border-radius:8px}
</style>
</head>
<body class="container">

<!-- 掃碼 -->
<div class="card mb-3">
  <div class="card-header">掃碼新增（條碼/QR）</div>
  <div class="card-body">
    <div class="d-flex gap-2 align-items-end flex-wrap">
      <div>
        <label class="form-label">相機</label>
        <select id="camSelect" class="form-select" style="min-width:220px"></select>
      </div>
      <button id="btnScanStart" class="btn btn-primary" type="button">啟動掃描</button>
      <button id="btnScanStop"  class="btn btn-outline-secondary" type="button">停止</button>

      <!-- 外部掃描器（你手機的條碼 App） -->
      <a id="extZX"     class="btn btn-outline-secondary" href="#">用外部掃描器</a>
      <a id="extIntent" class="btn btn-outline-secondary" href="#">用外部掃描器（Intent）</a>

      <button id="btnPhotoScan" class="btn btn-outline-secondary" type="button">拍照掃碼（備援）</button>
      <button id="btnTorch" class="btn btn-outline-dark d-none" type="button">手電筒</button>
      <input id="zoom" type="range" min="1" max="1" step="0.1" class="form-range d-none" style="max-width:220px">
      <span id="scanMsg" class="text-danger small ms-2"></span>
    </div>
    <video id="video" playsinline muted></video>
    <input id="fileScan" type="file" accept="image/*" capture="environment" class="d-none">
  </div>
</div>

<!-- 批次上傳 -->
<div class="card my-3">
  <div class="card-header">批次上傳 Excel → 入庫</div>
  <div class="card-body">
    <input id="bulkFile" type="file" accept=".xlsx,.xls" class="form-control" />
    <div class="form-text">欄位（第一列標題）：date, code, item, loc, exp, in, out, stock, barcode,timestamp（日期建議 YYYY-MM-DD）</div>
    <button id="btnBulk" class="btn btn-outline-success mt-2" type="button">上傳入庫</button>
    <small id="bulkMsg" class="text-muted ms-2"></small>
  </div>
</div>

<!-- 單筆輸入（支援只輸入：日期、料號、效期、數量） -->
<form id="matForm" class="row g-3 align-items-end">
  <div class="col-6 col-md-3">
    <label class="form-label">日期</label>
    <input id="matDate" type="date" class="form-control" required>
  </div>
  <div class="col-6 col-md-3">
    <label class="form-label">料號</label>
    <input id="matCode" type="text" class="form-control" placeholder="可只填此欄+效期+數量">
  </div>
  <div class="col-12 col-md-4">
    <label class="form-label">品項</label>
    <input id="matItem" type="text" class="form-control" required>
  </div>
  <div class="col-6 col-md-2">
    <label class="form-label">儲位</label>
    <input id="matLoc" type="text" class="form-control">
  </div>
  <div class="col-6 col-md-3">
    <label class="form-label">效期</label>
    <input id="matExp" type="date" class="form-control">
  </div>
  <div class="col-6 col-md-2">
    <label class="form-label">進料量(+)</label>
    <input id="matIn" type="number" step="any" class="form-control" value="0">
  </div>
  <div class="col-6 col-md-2">
    <label class="form-label">領料量(-)</label>
    <input id="matOut" type="number" step="any" class="form-control" value="0">
  </div>
  <div class="col-6 col-md-3">
    <label class="form-label">掃描條碼</label>
    <input id="matBarcode" type="text" class="form-control" placeholder="可由掃描自動帶入">
  </div>
  <div class="col-12 col-md-2 d-grid">
    <button class="btn btn-primary" type="submit">新增 / 更新</button>
  </div>
  <div class="col-12"><small id="saveMsg" class="text-success"></small></div>
</form>

<!-- 本地清單 -->
<div class="table-responsive mt-3">
  <table id="matTable" class="table table-sm table-striped">
    <thead class="table-light">
      <tr>
        <th>日期</th><th>條碼</th><th>料號</th><th>品項</th><th>儲位</th>
        <th>進料量</th><th>領料量</th><th>庫存量</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- 查詢 -->
<div class="card my-3">
  <div class="card-header">線上查詢（Google Sheet）</div>
  <div class="card-body">
    <div class="row g-2">
      <div class="col-6 col-md-3"><label class="form-label">日期自</label><input id="qFrom" type="date" class="form-control"></div>
      <div class="col-6 col-md-3"><label class="form-label">日期至</label><input id="qTo" type="date" class="form-control"></div>
      <div class="col-6 col-md-2"><label class="form-label">料號含</label><input id="qCode" type="text" class="form-control"></div>
      <div class="col-6 col-md-2"><label class="form-label">品項含</label><input id="qItem" type="text" class="form-control"></div>
      <div class="col-6 col-md-2"><label class="form-label">儲位含</label><input id="qLoc"  type="text" class="form-control"></div>
    </div>
    <div class="mt-2 d-flex flex-wrap gap-2">
      <button id="btnQuery" class="btn btn-outline-primary" type="button">查詢</button>
      <button id="btnQueryXlsx" class="btn btn-success" type="button">匯出查詢結果 Excel</button>
      <button id="btnSummary" class="btn btn-warning" type="button">彙總(同日×料號×品項×儲位)</button>
     </div>
    <div class="table-responsive mt-2">
      <table id="qTable" class="table table-sm">
        <thead><tr>
          <th>日期</th><th>條碼</th><th>料號</th><th>品項</th><th>儲位</th>
          <th>進料量</th><th>領料量</th><th>庫存量</th><th>寫入時間</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<hr>
<h5>預警檢查</h5>
<div class="d-flex gap-2 mb-2">
  <input id="warnExpDays" type="number" class="form-control w-auto" value="30" min="1">
  <label class="form-label">天內到期預警</label>
  <input id="warnLookback" type="number" class="form-control w-auto" value="60" min="7">
  <label class="form-label">天平均用量</label>
  <button id="btnAlerts" type="button" class="btn btn-outline-danger">檢查預警</button>
</div>
<div class="table-responsive">
  <table class="table table-sm table-bordered">
    <thead class="table-light">
      <tr><th colspan="6">到期預警</th></tr>
      <tr><th>品項</th><th>料號</th><th>儲位</th><th>效期</th><th>剩餘量</th><th>天數</th></tr>
    </thead>
    <tbody id="expBody"></tbody>
  </table>
</div>
<div class="table-responsive mt-3">
  <table class="table table-sm table-bordered">
    <thead class="table-light">
      <tr><th colspan="8">低庫存預警</th></tr>
      <tr>
        <th>品項</th><th>料號</th><th>儲位</th>
        <th>現庫存</th><th>近N日日均耗用</th><th>補貨點</th><th>覆蓋天數</th><th>建議下單</th>
      </tr>
    </thead>
    <tbody id="lowBody"></tbody>
  </table>
</div>

<script>
/*** 換成你自己的 GAS /exec ***/
const GAS_URL = 'https://script.google.com/macros/s/AKfycbxaL3r4RmKLHrS4c64Oec0D505I27q_R7wDmjchyRYI8yOUm_AfvORuRe3XV5dnl9GDyA/exec';

/*** DOM 快取 ***/
const video    = document.getElementById('video');
const camSel   = document.getElementById('camSelect');
const btnStart = document.getElementById('btnScanStart');
const btnStop  = document.getElementById('btnScanStop');
const btnPhoto = document.getElementById('btnPhotoScan');
const fileScan = document.getElementById('fileScan');
const scanMsg  = document.getElementById('scanMsg');
const btnTorch = document.getElementById('btnTorch');
const zoomEl   = document.getElementById('zoom');
const saveMsg  = document.getElementById('saveMsg');

const tbody    = document.querySelector('#matTable tbody');
const qBody    = document.querySelector('#qTable tbody');

let data = [];
let currentDeviceId = null;

/*** 進來就處理外部掃描器回呼 ?barcode=xxx，自動帶入主檔 ***/
(() => {
  const u = new URL(location.href);
  const bc = u.searchParams.get('barcode');
  if (bc) {
    document.getElementById('matBarcode').value = bc;
    lookupByBarcode(bc);
    history.replaceState({}, '', location.pathname);
  }
  const ret = encodeURIComponent(`${location.origin}${location.pathname}?barcode={CODE}`);
  document.getElementById('extZX').href =
    `zxing://scan/?ret=${ret}&SCAN_FORMATS=EAN_13%2CEAN_8%2CUPC_A%2CCODE_128%2CITF&PROMPT_MESSAGE=%E8%AB%8B%E6%8E%83%E6%A2%9D%E7%A2%BC`;
  document.getElementById('extIntent').href =
    `intent://scan/#Intent;scheme=zxing;package=com.teacapps.barcodescanner;S.ret=${ret};S.SCAN_FORMATS=EAN_13%2CEAN_8%2CUPC_A%2CCODE_128%2CITF;end`;
})();

/*** 主檔帶入（條碼或料號） ***/
let lookupTimer = null;
async function lookupByBarcode(barcode) {
  if (!barcode) return;
  clearTimeout(lookupTimer);
  lookupTimer = setTimeout(async () => {
    try {
      const res = await fetch(`${GAS_URL}?action=lookup&barcode=${encodeURIComponent(barcode)}`);
      const j = await res.json();
      if (j && j.found) {
        if (j.row.code)  matCode.value = j.row.code;
        if (j.row.item)  matItem.value = j.row.item;
        const loc = j.row.default_loc || '';
        if (loc) matLoc.value = loc;
        setScanMsg(`已帶入：${j.row.item||''}（料號 ${j.row.code||''}，儲位 ${loc||'-'}）`);
      } else {
        setScanMsg('主檔無此條碼，請手動輸入品項/料號/儲位後送出。');
      }
    } catch (e) { setScanMsg('查詢主檔失敗：'+e); }
  }, 120);
}
function setScanMsg(msg){ scanMsg.textContent = msg || ''; }
function handleBarcode(bc){
  if (!bc) return;
  matBarcode.value = bc;
  if (navigator.vibrate) navigator.vibrate(60);
  setScanMsg('條碼：' + bc);
  lookupByBarcode(bc);
}
document.getElementById('matBarcode').addEventListener('input', e=>{
  lookupByBarcode(e.target.value.trim());
});

/*** 權限 + 鏡頭列出 ***/
async function ensureCamPermission(){
  try{
    const s = await navigator.mediaDevices.getUserMedia({video:true});
    s.getTracks().forEach(t=>t.stop());
  }catch(e){
    setScanMsg('請允許相機權限'); throw e;
  }
}
camSel.addEventListener('change', async (e)=>{
  currentDeviceId = e.target.value || null;
  if (video.srcObject){ btnStop.click(); btnStart.click(); }
});

/*** ZXing + BarcodeDetector 備援 ***/
const formats = [
  ZXing.BarcodeFormat.EAN_13, ZXing.BarcodeFormat.EAN_8,
  ZXing.BarcodeFormat.UPC_A,  ZXing.BarcodeFormat.CODE_128,
  ZXing.BarcodeFormat.CODE_39, ZXing.BarcodeFormat.ITF
];
const hints = new Map([
  [ZXing.DecodeHintType.POSSIBLE_FORMATS, formats],
  [ZXing.DecodeHintType.TRY_HARDER, true],
  [ZXing.DecodeHintType.ASSUME_GS1, true]
]);
const zxingReader = new ZXing.BrowserMultiFormatReader(hints, 300);
const hasBD = 'BarcodeDetector' in window;
let bd=null; if (hasBD) { try{ bd=new BarcodeDetector({formats:['ean_13','ean_8','upc_a','code_128','code_39','itf']}); }catch{} }
let detectorLoop=null, currentTrack=null, torchOn=false;

function stopAll(){
  try{ zxingReader.reset(); }catch{}
  if (detectorLoop){ cancelAnimationFrame(detectorLoop); detectorLoop=null; }
}
async function listCams(){
  const devs = await navigator.mediaDevices.enumerateDevices();
  const cams = devs.filter(d=>d.kind==='videoinput');
  cams.sort((a,b)=>{
    const sa=(a.label||'').toLowerCase(), sb=(b.label||'').toLowerCase();
    const ra=/back|rear|environment/.test(sa)?0:1, rb=/back|rear|environment/.test(sb)?0:1;
    return ra-rb;
  });
  camSel.innerHTML = cams.map((d,i)=>`<option value="${d.deviceId}">${d.label||`camera ${i+1}`}</option>`).join('');
  currentDeviceId = cams[0]?.deviceId || null;
}
async function startZXing(deviceId){
  await zxingReader.decodeFromVideoDevice(deviceId, video, (result,err)=>{
    if (result){ handleBarcode(result.getText()); stopAll(); }
  });
}
function startBDLoop(){
  const cvs = document.createElement('canvas');
  const ctx = cvs.getContext('2d', {willReadFrequently:true});
  const tick = async ()=>{
    try{
      const w=video.videoWidth, h=video.videoHeight;
      if (w && h){
        cvs.width=w; cvs.height=h; ctx.drawImage(video,0,0,w,h);
        if (bd){
          const r = await bd.detect(cvs);
          if (r && r[0] && r[0].rawValue){ handleBarcode(r[0].rawValue); stopAll(); return; }
        }
      }
    }catch{}
    detectorLoop = requestAnimationFrame(tick);
  };
  detectorLoop = requestAnimationFrame(tick);
}
function bindTrackControls(track){
  currentTrack = track;
  const caps = track.getCapabilities ? track.getCapabilities() : {};
  if (caps.torch){
    btnTorch.classList.remove('d-none');
    btnTorch.onclick = async ()=> {
      torchOn = !torchOn;
      try { await track.applyConstraints({ advanced: [{ torch: torchOn }] }); } catch{}
      btnTorch.classList.toggle('active', torchOn);
    };
  } else { btnTorch.classList.add('d-none'); }
  if (caps.zoom){
    zoomEl.classList.remove('d-none');
    zoomEl.min  = caps.zoom.min  ?? 1;
    zoomEl.max  = caps.zoom.max  ?? 1;
    zoomEl.step = caps.zoom.step ?? 0.1;
    zoomEl.value= zoomEl.min;
    zoomEl.oninput = ()=> track.applyConstraints({advanced:[{zoom:Number(zoomEl.value)}]}).catch(()=>{});
  } else { zoomEl.classList.add('d-none'); }
}

/*** 啟停掃描 ***/
btnStart.addEventListener('click', async ()=>{
  setScanMsg(''); stopAll();
  if (!currentDeviceId) await listCams();
  try{
    const s = await navigator.mediaDevices.getUserMedia({
      video:{ deviceId: currentDeviceId?{exact:currentDeviceId}:undefined, facingMode:{ideal:'environment'},
              width:{ideal:1280}, height:{ideal:720} }, audio:false });
    video.srcObject = s; await video.play(); bindTrackControls(s.getVideoTracks()[0]);
  }catch(e){ setScanMsg('相機啟動失敗：'+e); return; }
  let ok = true; try{ await startZXing(currentDeviceId); }catch{ ok=false; }
  if (!ok && bd){ setScanMsg('改用備援偵測中…'); startBDLoop(); }
});
btnStop.addEventListener('click', ()=>{
  stopAll(); const s = video.srcObject; if (s){ s.getTracks().forEach(t=>t.stop()); video.srcObject=null; }
});

/*** 拍照掃碼備援 ***/
btnPhoto.addEventListener('click', ()=> fileScan.click());
fileScan.addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const url = URL.createObjectURL(f);
  try{
    const r = await zxingReader.decodeFromImageUrl(url);
    handleBarcode(r.getText());
  }catch{ setScanMsg('照片無法解碼，請換角度/距離/光線再試'); }
  URL.revokeObjectURL(url);
});

/*** 表單送出：先本地更新，再發到後端，由後端回傳 on-hand 覆寫 ***/
document.getElementById('matForm').addEventListener('submit', async e=>{
  e.preventDefault();
  saveMsg.textContent = '';

  const d   = matDate.value;
  const bc  = (matBarcode.value||'').trim();
  const code= matCode.value.trim();
  const it  = matItem.value.trim();
  const loc = matLoc.value.trim();
  const exp = (matExp.value||'').trim();
  const qIn = parseFloat(matIn.value)||0;
  const qOut= parseFloat(matOut.value)||0;

  // 畫面上的小表即時更新
  const stock = data.filter(r=>r.date===d && r.code===code && r.item===it && r.loc===loc)
                    .reduce((a,c)=>a+c.in-c.out,0) + qIn - qOut;
  const ex = data.find(r=>r.date===d && r.code===code && r.item===it && r.loc===loc);
  if (ex){ ex.in+=qIn; ex.out+=qOut; ex.stock=stock; }
  else   { data.push({date:d, barcode:bc, code, item:it, loc, in:qIn, out:qOut, stock}); }
  renderLocal();

  try{
    const r = await fetch(GAS_URL, {
      method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify({ date:d, barcode:bc, code, item:it, loc, exp, in:qIn, out:qOut })
    });
    const j = await r.json();
    if (j && j.ok){
      if (j.fill?.code) matCode.value = j.fill.code;
      if (j.fill?.item) matItem.value = j.fill.item;
      if (j.fill?.loc)  matLoc.value  = j.fill.loc;
      const last = data.find(r=>r.date===d && r.code===(j.fill?.code||code) && r.item===(j.fill?.item||it) && r.loc===(j.fill?.loc||loc));
      if (last) last.stock = j.onhand;
      renderLocal();
      saveMsg.textContent = `已寫入。現庫存：${j.onhand}`;
      setTimeout(()=>saveMsg.textContent='', 2500);
    }else{
      saveMsg.textContent = '寫入失敗：'+(j?.error||'');
    }
  }catch(err){
    saveMsg.textContent = '寫入失敗：'+err;
  }

  e.target.reset(); matDate.value = new Date().toISOString().slice(0,10);
});
function renderLocal(){
  tbody.innerHTML=''; data.sort((a,b)=>a.date.localeCompare(b.date)).forEach(r=>{
    tbody.insertAdjacentHTML('beforeend',
      `<tr><td>${r.date}</td><td>${r.barcode||''}</td><td>${r.code||''}</td>
           <td>${r.item||''}</td><td>${r.loc||''}</td>
           <td>${r.in||0}</td><td>${r.out||0}</td><td>${r.stock||0}</td></tr>`);
  });
}

/*** 查詢 / 匯出 / 彙總 ***/
document.getElementById('btnQuery').addEventListener('click', async ()=>{
  const qs = new URLSearchParams({
    action:'query', from:qFrom.value||'', to:qTo.value||'',
    code:qCode.value||'', item:qItem.value||'', loc:qLoc.value||''
  });
  try{
    const r = await fetch(`${GAS_URL}?${qs.toString()}`); const j = await r.json();
    qBody.innerHTML=''; (j.rows||[]).forEach(r=>{
      qBody.insertAdjacentHTML('beforeend', `<tr>
        <td>${r.date||''}</td><td>${r.barcode||''}</td><td>${r.code||''}</td>
        <td>${r.item||''}</td><td>${r.loc||''}</td>
        <td>${r.in||0}</td><td>${r.out||0}</td><td>${r.stock||0}</td><td>${r.ts||''}</td>
      </tr>`);
    });
    if (!j.rows?.length) qBody.innerHTML = `<tr><td colspan="9" class="text-muted">無資料</td></tr>`;
  }catch(e){ qBody.innerHTML = `<tr><td colspan="9" class="text-danger">查詢失敗：${e}</td></tr>`; }
});
document.getElementById('btnQueryXlsx').addEventListener('click', ()=>{
  const rows=[...qBody.querySelectorAll('tr')].map(tr=>[...tr.children].map(td=>td.textContent));
  const head=[...document.querySelectorAll('#qTable thead th')].map(th=>th.textContent);
  const ws=XLSX.utils.aoa_to_sheet([head, ...rows]); const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Query'); XLSX.writeFile(wb, 'query.xlsx');
});
document.getElementById('btnSummary').addEventListener('click', async ()=>{
  const qs = new URLSearchParams({
    action:'summary', from:qFrom.value||'', to:qTo.value||'',
    code:qCode.value||'', item:qItem.value||'', loc:qLoc.value||''
  });
  try{
    const r = await fetch(`${GAS_URL}?${qs.toString()}`); const j = await r.json();
    qBody.innerHTML=''; (j.rows||[]).forEach(r=>{
      qBody.insertAdjacentHTML('beforeend', `<tr>
        <td>${r.date||''}</td><td></td><td>${r.code||''}</td>
        <td>${r.item||''}</td><td>${r.loc||''}</td>
        <td>${r.in||0}</td><td>${r.out||0}</td><td>${r.stockEnd||0}</td><td></td>
      </tr>`);
    });
    if (!j.rows?.length) qBody.innerHTML = `<tr><td colspan="9" class="text-muted">無資料</td></tr>`;
  }catch(e){ qBody.innerHTML = `<tr><td colspan="9" class="text-danger">彙總失敗：${e}</td></tr>`; }
});

/*** 批次上傳（含 Excel 日期轉 ISO） ***/
function excelDateToISO(v){
  if (typeof v === 'number'){
    const d = XLSX.SSF.parse_date_code(v);
    const dt = new Date(Date.UTC(d.y, d.m-1, d.d));
    return dt.toISOString().slice(0,10);
  }
  if (typeof v === 'string'){
    const m = v.match(/(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/);
    if (m) return `${m[1]}-${('0'+(+m[2])).slice(-2)}-${('0'+(+m[3])).slice(-2)}`;
  }
  return '';
}
document.getElementById('btnBulk').addEventListener('click', async ()=>{
  const f=document.getElementById('bulkFile').files[0]; if(!f){ alert('請選擇 Excel'); return; }
  const ab=await f.arrayBuffer(); const wb=XLSX.read(ab); const ws=wb.Sheets[wb.SheetNames[0]];
  const arr=XLSX.utils.sheet_to_json(ws, {defval:''});
  const rows=arr.map(o=>({
    date: excelDateToISO(o.date||o.日期||''), code:o.code||o.料號||'', item:o.item||o.品項||'',
    loc: o.loc||o.儲位||'', exp: excelDateToISO(o.exp||o.效期||o.expiry||''),
    in: Number(o.in||o.進料量||0), out:Number(o.out||o.領料量||0),
    stock:Number(o.stock||o.庫存量||0), barcode:o.barcode||o.條碼||''
  })).filter(r=>r.date && (r.in||r.out||r.stock||r.code||r.item));
  if(!rows.length){ alert('沒有可匯入的資料列'); return; }
  const chunk=200;
  for(let i=0;i<rows.length;i+=chunk){
    const part=rows.slice(i,i+chunk);
    await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({rows:part})});
    document.getElementById('bulkMsg').textContent=`已上傳 ${Math.min(i+chunk, rows.length)} / ${rows.length}`;
  }
  alert('批次入庫完成');
});

/*** 預警（到期 + 低庫存） ***/
document.getElementById('btnAlerts').addEventListener('click', async ()=>{
  const expWithinDays=+document.getElementById('warnExpDays').value||30;
  const lookbackDays =+document.getElementById('warnLookback').value||60;
  try{
    const r=await fetch(`${GAS_URL}?action=alerts&expWithinDays=${expWithinDays}&lookbackDays=${lookbackDays}`);
    const j=await r.json();
    const expBody=document.getElementById('expBody'); expBody.innerHTML='';
    (j.expiry||[]).forEach(x=>{
      expBody.insertAdjacentHTML('beforeend', `<tr><td>${x.item}</td><td>${x.code}</td><td>${x.loc||''}</td>
        <td>${x.exp}</td><td>${x.qty}</td><td>${x.days_left}</td></tr>`);
    });
    if(!j.expiry?.length) expBody.innerHTML=`<tr><td colspan="6" class="text-muted">無到期預警</td></tr>`;

    const lowBody=document.getElementById('lowBody'); lowBody.innerHTML='';
    (j.lowStock||[]).forEach(x=>{
      lowBody.insertAdjacentHTML('beforeend', `<tr><td>${x.item}</td><td>${x.code}</td><td>${x.loc||''}</td>
        <td>${x.onhand}</td><td>${x.avg_daily}</td><td>${x.reorder_point}</td>
        <td>${x.days_cover}</td><td>${x.suggest_order}</td></tr>`);
    });
    if(!j.lowStock?.length) lowBody.innerHTML=`<tr><td colspan="8" class="text-muted">無低庫存預警</td></tr>`;
  }catch(e){
    document.getElementById('expBody').innerHTML=`<tr><td colspan="6" class="text-danger">預警查詢失敗：${e}</td></tr>`;
    document.getElementById('lowBody').innerHTML='';
  }
});

/*** 初始化 ***/
(function(){
  const t=new Date().toISOString().slice(0,10);
  matDate.value=t; qFrom.value=t; qTo.value=t;
  ensureCamPermission().then(listCams);
})();
</script>
</body>
</html>
